from androguard.misc import AnalyzeAPK


class WolfRat:
    def __init__(self, apk_path, output_dir):
        self.known_packages = ['com.google.services', 'com.android.playup']

        self.known_domains_ips = ["cvcws.ponethus.com", "svc.ponethus.com", "www.ponethus.com",
                                  "webmail.ponethus.com", "nampriknum.net", "www.nampriknum.net",
                                  "svc.nampriknum.net", "svcws.nampriknum.net", "svc.somtum.today",
                                  "svcws.somtum.today", "www.somtum.today", "somtum.today", "shop.databit.today",
                                  "svc.databit.today", "test.databit.today", "www.databit.today", "admin.databit.today",
                                  "cendata.today", "svc.cendata.today", "svcws.cendata.today", "www.cendata.today",
                                  "47.90.206.185"]  # 47.90.206.185: vpn IP

        self.known_strings = ["dumpsys activity | grep \"Run #\" | grep -v ScreenCaptureImageActivity | head -n 1",
                              "jp.naver.line.android/.activity.chathistory.ChatHistoryActivity",
                              "com.whatsapp/.voipcalling.VoipActivityV2",
                              "OrbotVpnThread", "OrbotVpn",
                              "jp.naver.line.android/com.linecorp.voip.ui.freecall.FreeCallActivity",
                              "com.android.playup", "/Bots/get_update",
                              # endpoints
                              "/Commands/comm_getfunction", "/Bots/get_update", "/Commands/delete_comm",
                              "/Filesautosend/upload_file", "/Filesautosend/delete_file", "/Messages/mess_update",
                              "/Transbots/bots_add", "/Authen/verify_token"]

        self.apk_path = apk_path
        # output directory
        self.output_dir = output_dir + "/"
        self.packed_files = dict()

        self.a, self.d, self.dx = AnalyzeAPK(self.apk_path)
        self.score = 0

    def check(self):

        if self.dx.find_classes('.*com.jaredrummler.android.shell.*'):
            # APK execute Shell commands founds :
            self.score += 1

        if self.dx.find_classes('.*com.serenegiant.*'):
            # Libcommon https://github.com/saki4510t/libcommon
            self.score += 1

        for string in self.known_strings:
            try:
                if next(self.dx.find_strings(string=string)):
                    # known "string" founded
                    self.score += 1
            except Exception:
                # No element
                continue

        return self.score